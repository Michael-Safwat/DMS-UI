<app-header></app-header>

<div *ngIf="workspace" class="workspace-details-container">
  <h1 class="workspace-title">{{ workspace.name }}</h1>

  <div class="workspace-meta">
    <p class="workspace-description">{{ workspace.description }}</p>
    <p class="workspace-created">Created At: {{ workspace.createdAt | date: 'medium' }}</p>
  </div>

  <div class="workspace-actions">
    <button pButton type="button" label="Update Workspace" icon="pi pi-pencil" class="p-button-warning"
            (click)="showUpdateDialog()"></button>
    <button pButton type="button" label="Delete Workspace" icon="pi pi-trash" class="p-button-danger"
            (click)="showDeleteDialog()"></button>
  </div>
</div>

<div *ngIf="!workspace">
  <p>Loading workspace details...</p>
</div>

<p-dialog header="Confirm Delete Workspace" [(visible)]="deleteDialogVisible" [modal]="true" [closable]="false">
  <p>To confirm deletion, please enter the workspace name:</p>

  <input type="text" placeholder="Workspace name" [(ngModel)]="deleteConfirmationName" class="confirmation-input">

  <p-message *ngIf="deleteConfirmationName && deleteConfirmationName !== workspace.name"
             severity="error" text="Workspace name does not match"></p-message>

  <p-footer>
    <button pButton label="Cancel" icon="pi pi-times" class="p-button-secondary"
            (click)="deleteDialogVisible = false"></button>
    <button pButton label="Delete" icon="pi pi-check" class="p-button-danger"
            [disabled]="deleteConfirmationName !== workspace.name"
            (click)="deleteWorkspace()"></button>
  </p-footer>
</p-dialog>

<p-dialog header="Update Workspace" [(visible)]="updateDialogVisible" [modal]="true" [closable]="false">

  <label for="workspace_name">Workspace Name</label>
  <input type="text" placeholder="Workspace name" id="workspace_name" [(ngModel)]="updatedName"
         class="confirmation-input">
  <label for="workspace_description">Workspace Description</label>
  <input type="text" placeholder="Workspace name" id="workspace_description" [(ngModel)]="updatedDescription"
         class="confirmation-input">

  <p-message *ngIf="updatedName === workspace.name && updatedDescription === workspace.description"
             severity="error" text="Workspace data not changed"></p-message>

  <p-footer>
    <button pButton label="Cancel" icon="pi pi-times" class="p-button-secondary"
            (click)="updateDialogVisible = false"></button>
    <button pButton label="Update" icon="pi pi-check" class="p-button-warning"
            [disabled]="updatedName === workspace.name && updatedDescription === workspace.description"
            (click)="updateWorkspace(updatedName,updatedDescription)"></button>
  </p-footer>
</p-dialog>

<p-table
  #dt
  [value]="documents"
  [rows]="10"
  [globalFilterFields]="['name', 'type', 'creation_date']"
  [tableStyle]="{ 'min-width': '75rem' }"
  [rowHover]="true"
  dataKey="id"
>
  <ng-template pTemplate="caption">
    <div class="flex align-items-center justify-content-between">
      <span class="p-input-icon-right">
      <p-fileUpload mode="basic" accept="image/*, .pdf, .txt" name="file"
                    url="http://localhost:8080/workspaces/{{workspace.id}}/documents" (onUpload)="onUpload($event)"
                    [maxFileSize]="1000000" label="upload" chooseLabel="upload files" class="mr-2 inline-block" [multiple]="false">
      </p-fileUpload>
      </span>
      <span class="p-input-icon-left">
                <i class="pi pi-search"></i>
                <input pInputText type="text" (input)="dt.filterGlobal($event.target, 'contains')" placeholder="Search..." />
            </span>
    </div>
  </ng-template>
  <ng-template pTemplate="header">
    <tr>
      <th pSortableColumn="name" style="min-width:15rem">Name <p-sortIcon field="name"></p-sortIcon></th>
      <th pSortableColumn="type" style="min-width:10rem">Type <p-sortIcon field="type"></p-sortIcon></th>
      <th pSortableColumn="createdAt">Creation time<p-sortIcon field="createdAt"></p-sortIcon></th>
      <th></th>
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-document>
    <tr>

      <td> <div class="text-center">
        <p-button label="{{document.name}}" [link]="true" (click)="previewDocument(document.id,document.type)"></p-button></div>
      </td>
      <td>{{ document.type }}</td>
      <td>{{ document.createdAt | date: 'medium' }}</td>
      <td>
        <button pButton pRipple icon="pi pi-pencil" class="p-button-rounded p-button-success mr-2" (click)="confirmUpdate(document)"></button>
        <button pButton pRipple icon="pi pi-download" class="p-button-rounded p-button-info mr-2" (click)="downloadDocument(document.id)"></button>
        <button pButton pRipple icon="pi pi-trash" class="p-button-rounded p-button-danger mr-2" (click)="confirmDelete(document.id)"></button>
      </td>
    </tr>
  </ng-template>
</p-table>


<p-dialog [(visible)]="displayModal" [modal]="true" [style]="{width: '90vw', height: '90vh'}" [dismissableMask]="true" [closable]="true">
  <ng-container *ngIf="documentUrl">
    <iframe [src]="documentUrl" class="document-preview" ></iframe>
  </ng-container>
</p-dialog>

<p-toast></p-toast>
<p-confirmDialog [style]="{width: '50vw'}"></p-confirmDialog>

<p-dialog header="Update Workspace" [(visible)]="updateDocumentDialog" [modal]="true" [closable]="false">

  <label for="workspace_name">Document Name</label>
  <input type="text" placeholder="Document name" id="document_name" [(ngModel)]="updatedDocumentName"
         class="confirmation-input">

  <p-message *ngIf="updatedDocumentName === document.name"
             severity="error" text="Workspace data not changed"></p-message>

  <p-footer>
    <button pButton label="Cancel" icon="pi pi-times" class="p-button-secondary"
            (click)="updateDocumentDialog = false"></button>
    <button pButton label="Update" icon="pi pi-check" class="p-button-warning"
            [disabled]="updatedDocumentName === document.name"
            (click)="updateDocument(updatedDocumentName)"></button>
  </p-footer>
</p-dialog>

